{% set hosts=[] %}
{% for h in groups['all'] | difference(['bastion']) %}
{% do hosts.append(hostvars[h]['ansible_ssh_host']|default(hostvars[h]['ansible_host'])) %}
{% endfor %}

Host {{ bastion_ip }}
  Hostname {{ bastion_ip }}
  StrictHostKeyChecking no
  ControlMaster auto
  ControlPath ~/.ssh/ansible-%r@%h:%p
  ControlPersist 5m

Host {{ hosts|join(' ') }}
  ProxyCommand ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p {{ real_user }}@{{ bastion_ip }} {% if ansible_ssh_private_key_file is defined %}-i {{ ansible_ssh_private_key_file }}{% endif %}
